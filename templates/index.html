<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Âæ©Áøí„É™„Çπ„Éà</title>
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Yu Gothic", YuGothic, sans-serif;
            background: #f8f9fa;
            color: #333;
            line-height: 1.5;
            padding: 16px;
            max-width: 600px;
            margin: 0 auto;
            padding-bottom: 60px;
        }
        
        h1 {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
            color: #1a1a1a;
        }
        
        /* „Ç´„ÉÜ„Ç¥„É™„Éò„ÉÉ„ÉÄ„Éº */
        .cat-header {
            font-size: 0.9rem;
            font-weight: bold;
            color: #444;
            background: #e9ecef;
            padding: 6px 10px;
            margin: 20px 0 8px 0;
            border-radius: 4px;
            border-left: 4px solid #333;
            display: flex;
            justify-content: space-between;
        }
        
        /* „Ç´„Éº„Éâ */
        .card {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
        }
        
        .card.urgent { border-left: 4px solid #ff6b6b; }
        
        .card-text {
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 6px;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed #eee;
        }
        
        .card-meta {
            font-size: 0.75rem;
            color: #999;
        }

        /* „Éú„Çø„É≥ */
        button { cursor: pointer; font-family: inherit; }
        
        .btn-sm {
            padding: 5px 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85rem;
            background: #fff;
            color: #555;
        }
        
        .btn-done {
            background: #333;
            color: #fff;
            border-color: #333;
            font-weight: bold;
        }
        
        .btn-again {
            color: #d32f2f;
            border-color: #ffcdd2;
            background: #fff;
        }

        /* ÂÖ•Âäõ„Ç®„É™„Ç¢ */
        .section { margin-top: 40px; }
        
        .add-area {
            background: #fff;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            resize: vertical;
            margin-bottom: 10px;
        }
        
        .input-row { display: flex; gap: 8px; margin-bottom: 10px; }
        .input-cat { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }

        /* ÂÆå‰∫Ü„É°„ÉÉ„Çª„Éº„Ç∏ */
        .empty-state {
            text-align: center;
            padding: 40px 0;
            color: #aaa;
            font-size: 0.9rem;
            background: #fff;
            border-radius: 8px;
            border: 1px dashed #ddd;
        }

        /* „Éï„ÉÉ„Çø„Éº„ÅÆÁ∞°ÊòìÂÖ•Âäõ */
        .quick-record-section {
            margin-top: 50px;
            padding-top: 20px;
            border-top: 4px double #eee;
        }
        .quick-label {
            font-size: 0.8rem;
            color: #999;
            text-align: center;
            margin-bottom: 10px;
        }

        /* „É°„ÉÉ„Çª„Éº„Ç∏ */
        .flash {
            padding: 10px 16px;
            border-radius: 4px;
            margin-bottom: 16px;
            font-size: 0.9rem;
        }
        .flash.success { background: #d4edda; color: #155724; }
        .flash.info { background: #d1ecf1; color: #0c5460; }
        .flash.danger { background: #f8d7da; color: #721c24; }
        
        /* „ÉÑ„Éº„É´„É™„É≥„ÇØ */
        .footer-links {
            text-align: center;
            margin-top: 30px;
            color: #ccc;
            font-size: 0.75rem;
        }
        .footer-links button, .footer-links label {
            background: none; border: none; color: #999; cursor: pointer; margin: 0 5px;
        }
    </style>
</head>
<body>
    <h1>Âæ©Áøí„É™„Çπ„Éà</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="flash {{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div id="today-list">
        {% if items_by_cat %}
            {% for category, items in items_by_cat.items() %}
                <div class="cat-header">
                    <span>{{ category }}</span>
                    <span style="font-weight:normal; opacity:0.6;">{{ items|length }}</span>
                </div>
                {% for item in items %}
                <div class="card {% if item.review_level == 0 and not item.is_completed %}urgent{% endif %}">
                    <div class="card-text">{{ item.topic }}</div>
                    {% if item.url %}<div style="font-size:0.8rem; color:#888; margin-bottom:4px;">Memo: {{ item.url }}</div>{% endif %}
                    
                    <div class="card-footer">
                        <span class="card-meta">
                            {% if item.is_completed %}ÂÆå‰∫ÜÁ¢∫Ë™ç{% else %}Lv.{{ item.review_level }}{% endif %}
                        </span>
                        <div style="display:flex; gap:8px;">
                            <form action="{{ url_for('review_item', item_id=item.id) }}" method="POST">
                                <button type="submit" name="confidence" value="again" class="btn-sm btn-again">„Éë„Çπ</button>
                            </form>
                            <form action="{{ url_for('review_item', item_id=item.id) }}" method="POST">
                                <button type="submit" name="confidence" value="good" class="btn-sm btn-done">OK</button>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <div style="font-size:1.5rem; margin-bottom:8px;">üéâ</div>
                ‰ªäÊó•„ÅÆÂæ©Áøí„ÅØ„Åô„Åπ„Å¶ÂÆå‰∫Ü„Åß„Åô
            </div>
        {% endif %}
    </div>

    <div class="section">
        <h3 style="font-size:1rem; margin-bottom:10px; color:#555;">Êñ∞Ë¶èÈ†ÖÁõÆ„ÇíËøΩÂä†</h3>
        <div class="add-area">
            <form action="{{ url_for('add_item') }}" method="POST">
                <textarea name="topic" rows="3" placeholder="Ë¶ö„Åà„Åü„ÅÑ„Åì„Å®„ÇíÂÖ•Âäõ..." required></textarea>
                <div class="input-row">
                    <input type="text" name="category" class="input-cat" placeholder="„Ç´„ÉÜ„Ç¥„É™ (‰æã: Ê∞ëÊ≥ï)">
                </div>
                <div style="display:flex; gap:8px;">
                    <button type="submit" name="initial_confidence" value="again" class="btn-sm" style="flex:1;">Èõ£„Åó„ÅÑ (Lv.0)</button>
                    <button type="submit" name="initial_confidence" value="good" class="btn-sm btn-done" style="flex:1;">OK (Lv.1)</button>
                </div>
            </form>
        </div>
    </div>

    <div class="section" style="margin-top:20px;">
        <details>
            <summary style="cursor:pointer; color:#999; padding:10px; font-size:0.85rem; text-align:center;">„Åô„Åπ„Å¶„ÅÆÈ†ÖÁõÆ„ÇíÁÆ°ÁêÜ ({{ all_items_by_cat.values() | map('length') | sum }})</summary>
            <div style="margin-top:10px; background:#fff; border-radius:8px; border:1px solid #eee; padding:10px;">
                {% for category, items in all_items_by_cat.items() %}
                    <div style="font-size:0.8rem; font-weight:bold; color:#666; margin-top:10px; border-bottom:1px solid #f0f0f0;">{{ category }}</div>
                    {% for item in items %}
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid #f9f9f9;">
                        <span style="flex:1; font-size:0.85rem; padding-right:8px;" onclick="editItem({{ item.id }})" id="text-{{ item.id }}">{{ item.topic }}</span>
                        <form action="{{ url_for('delete_item', item_id=item.id) }}" method="POST" onsubmit="return confirm('ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü');">
                            <button type="submit" style="color:#ccc; background:none; border:none; font-size:1rem;">√ó</button>
                        </form>
                    </div>
                    {% endfor %}
                {% endfor %}
            </div>
        </details>
    </div>

    <div class="quick-record-section">
        <div class="quick-label">‰ªäÊó•„ÇÑ„Å£„Åü„Åì„Å®„Çí„Çµ„ÇØ„ÉÉ„Å®Ë®òÈå≤</div>
        <form action="{{ url_for('add_item') }}" method="POST" style="display:flex; gap:8px;">
            <input type="hidden" name="category" value="„É≠„Ç∞">
            <input type="text" name="topic" placeholder="‰æã: Âà§‰æãÁôæÈÅ∏ 45„Äú50" required style="flex:1; padding:8px; border:1px solid #ddd; border-radius:4px;">
            <button type="submit" name="initial_confidence" value="good" class="btn-sm btn-done" style="white-space:nowrap;">Ë®òÈå≤</button>
        </form>
    </div>

    <div class="footer-links">
        <button onclick="sendNow()">ÈÄöÁü•„ÉÜ„Çπ„Éà</button> |
        <button onclick="exportData()">‰øùÂ≠ò</button> |
        <label>Âæ©ÂÖÉ <input type="file" accept=".json" onchange="importData(event)" style="display:none;"></label>
    </div>

    <script>
        async function sendNow() {
            const r = await fetch('/api/send-reminder', { method: 'POST' });
            const d = await r.json();
            alert(d.message || (d.success ? 'ÈÄÅ‰ø°OK' : '„Ç®„É©„Éº'));
        }
        
        async function exportData() {
            const r = await fetch('/api/export');
            const data = await r.json();
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'backup_' + new Date().toISOString().slice(0,10) + '.json';
            a.click();
        }
        
        async function importData(event) {
            if (!confirm('„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Åã„ÇâÂæ©ÂÖÉ„Åó„Åæ„Åô„ÅãÔºü')) return;
            const file = event.target.files[0];
            const text = await file.text();
            await fetch('/api/import', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: text
            });
            location.reload();
        }
        
        function editItem(id) {
            const span = document.getElementById('text-' + id);
            const current = span.textContent;
            const res = prompt("Á∑®ÈõÜ:", current);
            if (res && res !== current) {
                fetch('/api/edit/' + id, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({topic: res})
                }).then(()=> span.textContent = res);
            }
        }
    </script>
</body>
</html>