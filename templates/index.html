<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾©ç¿’ãƒªã‚¹ãƒˆ</title>
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            /* â–¼â–¼â–¼ ãƒ•ã‚©ãƒ³ãƒˆè¨­å®šã‚’å¤‰æ›´ã—ã¾ã—ãŸ â–¼â–¼â–¼ */
            font-family: "Hiragino Kaku Gothic ProN", "Hiragino Sans", -apple-system, BlinkMacSystemFont, sans-serif;
            font-feature-settings: "palt"; /* æ–‡å­—è©°ã‚ã‚’ç¾ã—ã */
            
            background: #f8f9fa;
            color: #333;
            line-height: 1.6; /* èª­ã¿ã‚„ã™ãå°‘ã—åºƒã’ã¾ã—ãŸ */
            padding: 16px;
            max-width: 600px;
            margin: 0 auto;
            padding-bottom: 80px;
        }
        
        h1 {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
            color: #1a1a1a;
        }
        
        /* ã‚«ãƒ†ã‚´ãƒªãƒ˜ãƒƒãƒ€ãƒ¼ */
        .cat-header {
            font-size: 0.9rem;
            font-weight: bold;
            color: #444;
            background: #e9ecef;
            padding: 6px 10px;
            margin: 20px 0 8px 0;
            border-radius: 4px;
            border-left: 4px solid #333;
            display: flex;
            justify-content: space-between;
        }
        
        /* ã‚«ãƒ¼ãƒ‰ */
        .card {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
        }
        .card.urgent { border-left: 4px solid #ff6b6b; }
        
        .card-text {
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 6px;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed #eee;
        }
        
        .card-meta { font-size: 0.75rem; color: #999; }

        /* ãƒœã‚¿ãƒ³ */
        button { cursor: pointer; font-family: inherit; }
        .btn-sm {
            padding: 5px 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85rem;
            background: #fff;
            color: #555;
        }
        .btn-done { background: #333; color: #fff; border-color: #333; font-weight: bold; }
        .btn-again { color: #d32f2f; border-color: #ffcdd2; background: #fff; }

        /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
        .section { margin-top: 40px; }
        .add-area {
            background: #fff;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            resize: vertical;
            margin-bottom: 10px;
            font-family: inherit; /* ãƒ•ã‚©ãƒ¼ãƒ å†…ã‚‚ãƒ•ã‚©ãƒ³ãƒˆç¶™æ‰¿ */
        }
        .input-row { display: flex; gap: 8px; margin-bottom: 10px; }
        .input-cat { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; }

        /* å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .empty-state {
            text-align: center; padding: 40px 0; color: #aaa;
            font-size: 0.9rem; background: #fff; border-radius: 8px; border: 1px dashed #ddd;
        }

        /* ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 1000;
            display: none; align-items: flex-end; justify-content: center;
        }
        .modal-overlay.open { display: flex; }
        
        .modal-content {
            background: #fff; width: 100%; max-width: 600px;
            border-radius: 12px 12px 0 0; padding: 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            animation: slideUp 0.2s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .modal-label { font-size: 0.8rem; font-weight: bold; color: #666; margin-bottom: 4px; }
        .date-btns { display: flex; gap: 6px; margin-bottom: 12px; }
        .date-btns button {
            padding: 4px 8px; font-size: 0.75rem; background: #f0f0f0; border: none; border-radius: 4px;
        }

        /* ç®¡ç†ãƒªã‚¹ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .mgmt-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 0; border-bottom: 1px solid #f0f0f0;
        }
        .mgmt-text { flex: 1; font-size: 0.9rem; margin-right: 10px; cursor: pointer; color: #333; }
        .mgmt-meta { font-size: 0.75rem; color: #999; margin-right: 8px; }

        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .flash { padding: 10px 16px; border-radius: 4px; margin-bottom: 16px; font-size: 0.9rem; }
        .flash.success { background: #d4edda; color: #155724; }
        .flash.info { background: #d1ecf1; color: #0c5460; }
        
        /* ãƒ•ãƒƒã‚¿ãƒ¼ */
        .footer-links {
            text-align: center; margin-top: 30px; color: #ccc; font-size: 0.75rem;
        }
        .footer-links button, .footer-links label {
            background: none; border: none; color: #999; cursor: pointer; margin: 0 5px;
        }
    </style>
</head>
<body>
    <h1>å¾©ç¿’ãƒªã‚¹ãƒˆ</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="flash {{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div id="today-list">
        {% if items_by_cat %}
            {% for category, items in items_by_cat.items() %}
                <div class="cat-header">
                    <span>{{ category }}</span>
                    <span style="font-weight:normal; opacity:0.6;">{{ items|length }}</span>
                </div>
                {% for item in items %}
                <div class="card {% if item.review_level == 0 and not item.is_completed %}urgent{% endif %}">
                    <div class="card-text">{{ item.topic }}</div>
                    {% if item.url %}<div style="font-size:0.8rem; color:#888; margin-bottom:4px;">Memo: {{ item.url }}</div>{% endif %}
                    
                    <div class="card-footer">
                        <span class="card-meta">
                            {% if item.is_completed %}å®Œäº†ç¢ºèª{% else %}Lv.{{ item.review_level }}{% endif %}
                        </span>
                        <div style="display:flex; gap:8px;">
                            <form action="{{ url_for('review_item', item_id=item.id) }}" method="POST">
                                <button type="submit" name="confidence" value="again" class="btn-sm btn-again">ãƒ‘ã‚¹</button>
                            </form>
                            <form action="{{ url_for('review_item', item_id=item.id) }}" method="POST">
                                <button type="submit" name="confidence" value="good" class="btn-sm btn-done">OK</button>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <div style="font-size:1.5rem; margin-bottom:8px;">ğŸ‰</div>
                ä»Šæ—¥ã®å¾©ç¿’ã¯ã™ã¹ã¦å®Œäº†ã§ã™
            </div>
        {% endif %}
    </div>

    <div class="section">
        <h3 style="font-size:1rem; margin-bottom:10px; color:#555;">æ–°è¦é …ç›®ã‚’è¿½åŠ </h3>
        <div class="add-area">
            <form action="{{ url_for('add_item') }}" method="POST">
                <textarea name="topic" rows="3" placeholder="è¦šãˆãŸã„ã“ã¨ã‚’å…¥åŠ›..." required></textarea>
                <div class="input-row">
                    <input type="text" name="category" class="input-cat" placeholder="ã‚«ãƒ†ã‚´ãƒª (ä¾‹: æ°‘æ³•)">
                </div>
                <div style="display:flex; gap:8px;">
                    <button type="submit" name="initial_confidence" value="again" class="btn-sm" style="flex:1;">é›£ã—ã„ (Lv.0)</button>
                    <button type="submit" name="initial_confidence" value="good" class="btn-sm btn-done" style="flex:1;">OK (Lv.1)</button>
                </div>
            </form>
        </div>
    </div>

    <div class="section" style="margin-top:20px;">
        <details>
            <summary style="cursor:pointer; color:#999; padding:10px; font-size:0.85rem; text-align:center;">
                ã™ã¹ã¦ã®é …ç›®ã‚’ç®¡ç† ({{ all_items_by_cat.values() | map('length') | sum }})
            </summary>
            
            <div style="background:#fff; border-radius:8px; border:1px solid #eee; padding:16px; margin-top:10px;">
                <div style="margin-bottom:16px;">
                    <select id="cat-filter" onchange="filterItems(this.value)" style="width:100%; padding:8px; border-radius:4px; border:1px solid #ddd; background:#f9f9f9; font-family:inherit;">
                        <option value="ALL">ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒªã‚’è¡¨ç¤º</option>
                        {% for category in all_items_by_cat.keys() %}
                            <option value="{{ category }}">{{ category }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div id="mgmt-list">
                    {% for category, items in all_items_by_cat.items() %}
                        <div class="mgmt-group" data-cat="{{ category }}">
                            <div style="font-size:0.8rem; font-weight:bold; color:#666; margin:12px 0 4px 0; border-bottom:1px solid #f0f0f0;">{{ category }}</div>
                            {% for item in items %}
                            <div class="mgmt-item">
                                <div class="mgmt-text" onclick="openEditModal({{ item.id }}, `{{ item.topic|replace('`', '') }}`, `{{ item.category }}`, `{{ item.next_review_date.strftime('%Y-%m-%d') }}`)">
                                    {{ item.topic }}
                                </div>
                                <span class="mgmt-meta" style="min-width:70px; text-align:right;">{{ item.next_review_date.strftime('%m/%d') }}</span>
                                <form action="{{ url_for('delete_item', item_id=item.id) }}" method="POST" onsubmit="return confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');">
                                    <button type="submit" style="color:#ccc; background:none; border:none; font-size:1.2rem;">Ã—</button>
                                </form>
                            </div>
                            {% endfor %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        </details>
    </div>

    <div class="section" style="padding-top:20px; border-top:4px double #eee;">
        <div style="font-size:0.8rem; color:#999; text-align:center; margin-bottom:10px;">ä»Šæ—¥ã‚„ã£ãŸã“ã¨ã‚’ã‚µã‚¯ãƒƒã¨è¨˜éŒ²</div>
        <form action="{{ url_for('add_item') }}" method="POST" style="display:flex; gap:8px;">
            <input type="hidden" name="category" value="ãƒ­ã‚°">
            <input type="text" name="topic" placeholder="ä¾‹: åˆ¤ä¾‹ç™¾é¸ 45ã€œ50" required style="flex:1; padding:8px; border:1px solid #ddd; border-radius:4px; font-family:inherit;">
            <button type="submit" name="initial_confidence" value="good" class="btn-sm btn-done" style="white-space:nowrap;">è¨˜éŒ²</button>
        </form>
    </div>

    <div class="footer-links">
        <button onclick="sendNow()">é€šçŸ¥ãƒ†ã‚¹ãƒˆ</button> |
        <button onclick="exportData()">ä¿å­˜</button> |
        <label>å¾©å…ƒ <input type="file" accept=".json" onchange="importData(event)" style="display:none;"></label>
    </div>

    <div id="edit-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-bottom:16px;">å†…å®¹ã‚’ç·¨é›†</h3>
            
            <div class="modal-label">å•é¡Œæ–‡</div>
            <textarea id="edit-topic" rows="5" style="width:100%; border:1px solid #333;"></textarea>
            
            <div class="modal-label">ã‚«ãƒ†ã‚´ãƒª</div>
            <input type="text" id="edit-cat" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; margin-bottom:10px; font-family:inherit;">

            <div class="modal-label">æ¬¡å›ã®å¾©ç¿’æ—¥</div>
            <div style="display:flex; gap:8px; align-items:center; margin-bottom:6px;">
                <input type="date" id="edit-date" style="padding:6px; border:1px solid #ddd; border-radius:4px; font-family:inherit;">
                <span id="date-diff" style="font-size:0.8rem; color:#888;"></span>
            </div>
            <div class="date-btns">
                <button onclick="setDateOffset(0)">ä»Šæ—¥</button>
                <button onclick="setDateOffset(1)">æ˜æ—¥</button>
                <button onclick="setDateOffset(3)">3æ—¥å¾Œ</button>
                <button onclick="setDateOffset(7)">æ¥é€±</button>
            </div>

            <div style="display:flex; gap:10px; margin-top:20px;">
                <button onclick="closeEditModal()" class="btn-sm" style="flex:1; padding:12px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onclick="saveEdit()" class="btn-sm btn-done" style="flex:1; padding:12px;">ä¿å­˜ã™ã‚‹</button>
            </div>
        </div>
    </div>

    <script>
        // --- ãƒ•ã‚£ãƒ«ã‚¿æ©Ÿèƒ½ ---
        function filterItems(val) {
            const groups = document.querySelectorAll('.mgmt-group');
            groups.forEach(g => {
                if(val === 'ALL' || g.getAttribute('data-cat') === val) {
                    g.style.display = 'block';
                } else {
                    g.style.display = 'none';
                }
            });
        }

        // --- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«æ©Ÿèƒ½ ---
        let currentEditId = null;
        
        function openEditModal(id, topic, cat, dateStr) {
            currentEditId = id;
            document.getElementById('edit-topic').value = topic;
            document.getElementById('edit-cat').value = cat;
            document.getElementById('edit-date').value = dateStr;
            document.getElementById('edit-modal').classList.add('open');
            document.getElementById('edit-topic').focus();
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('open');
            currentEditId = null;
        }

        function setDateOffset(days) {
            const d = new Date();
            d.setDate(d.getDate() + days);
            const yyyy = d.getFullYear();
            const mm = ('0'+(d.getMonth()+1)).slice(-2);
            const dd = ('0'+d.getDate()).slice(-2);
            document.getElementById('edit-date').value = `${yyyy}-${mm}-${dd}`;
        }

        async function saveEdit() {
            if(!currentEditId) return;
            const topic = document.getElementById('edit-topic').value;
            const cat = document.getElementById('edit-cat').value;
            const dateVal = document.getElementById('edit-date').value;

            // 1. å†…å®¹ã¨ã‚«ãƒ†ã‚´ãƒªã®æ›´æ–°
            const formData = new URLSearchParams();
            formData.append('topic', topic);
            formData.append('url', '');
            formData.append('category', cat);

            // 2. æ—¥ä»˜ã®æ›´æ–°
            const dateData = new URLSearchParams();
            dateData.append('new_date', dateVal);

            try {
                await Promise.all([
                    fetch(`/edit/${currentEditId}`, { method: 'POST', body: formData }),
                    fetch(`/update_date/${currentEditId}`, { method: 'POST', body: dateData })
                ]);
                location.reload();
            } catch(e) {
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // --- ãã®ä»– ---
        async function sendNow() {
            const r = await fetch('/api/send-reminder', { method: 'POST' });
            const d = await r.json();
            alert(d.message || (d.success ? 'é€ä¿¡OK' : 'ã‚¨ãƒ©ãƒ¼'));
        }
        
        async function exportData() {
            const r = await fetch('/api/export');
            const data = await r.json();
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = 'backup.json'; a.click();
        }
        
        async function importData(event) {
            if (!confirm('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ')) return;
            const file = event.target.files[0];
            const text = await file.text();
            await fetch('/api/import', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: text });
            location.reload();
        }
    </script>
</body>
</html>